<!DOCTYPE html>
<html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
  <title>CoordinateConversion widget - Custom Formats - 4.9</title>

  <link rel="stylesheet" href="https://js.arcgis.com/4.9/esri/css/main.css">

  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
    }
  </style>

  <script src="https://js.arcgis.com/4.28/"></script>

  <script>
    require([
      "esri/Map",
      "esri/views/MapView",
      "esri/widgets/CoordinateConversion",
      "esri/widgets/CoordinateConversion/support/Format",
      "esri/widgets/CoordinateConversion/support/Conversion",
      "esri/geometry/Point",
      "esri/layers/ImageryTileLayer",
      "esri/geometry/support/webMercatorUtils",
      "esri/geometry/SpatialReference"
    ], function(
      Map, MapView, CoordinateConversion, Format, Conversion,
      Point, ImageryTileLayer, webMercatorUtils, SpatialReference
    ) {
        demImageLayer = new ImageryTileLayer ({
            url:"https://tiledimageservices1.arcgis.com/RW2IdRvIbmA3FJ1X/arcgis/rest/services/Bathy_Oropa_1m/ImageServer",
            popupEnabled: true,
            //popupTemplate: imagePopupTemplate
          });

      var map = new Map({
        basemap: "oceans",
        layers: [demImageLayer]
        //ground: "world-elevation"
      });

      var view = new MapView({
        container: "viewDiv",
        map: map,
        center: [-124.2353, 44.5687], // Longitude, latitude
            zoom: 11, // Zoom level
            container: "viewDiv" // Div element
       });

      view.when(function(view) {
        view.goTo({
          tilt: 45
        })
      });

      var ccWidget = new CoordinateConversion({
        view: view
      });

      view.ui.add(ccWidget, "top-right");

      // Regular expression to find a number
      var numberSearchPattern = /-?\d+[\.]?\d*/;

      /**
       * Create a new Format called XYZ, which looks like: "<Latitude>, <Longitude>, <Z>"
       *
       * We need to define a convert function, a reverse convert function,
       * and some formatting information.
       */
      var newFormat = new Format({
        // The format's name should be unique with respect to other formats used by the widget
        name: "XYZ",
        conversionInfo: {
          // Define a convert function
          // Point -> Position
          convert: function(point) {
            var returnPoint = point.spatialReference.isWGS84 ? point :
              webMercatorUtils.webMercatorToGeographic(point);
            var x = returnPoint.x.toFixed(4);
            var y = returnPoint.y.toFixed(4);
            //var z = returnPoint.z.toFixed(4);
            bob = demImageLayer.identify(returnPoint);
            bob.then((response) => {
              Cathy = Math.round(response.value * 10) / 10;
            });
            var z = Cathy;
            //console.log(z);
            return {
              location: returnPoint,
              //coordinate: `${x}, ${y}`
              coordinate: `${x}, ${y}, ${z}`
              //coordinate: `${x}, ${y}, ${Cathy}`
            };
          },
          // Define a reverse convert function
          // String -> Point
          reverseConvert: function(string) {
            var parts = string.split(",")
            return new Point({
              x: parseFloat(parts[0]),
              y: parseFloat(parts[1]),
              z: parseFloat(parts[2]),
              spatialReference: {
                wkid: 4326
              }
            });
         }
        },
        // Define each segment of the coordinate
        coordinateSegments: [
        {
          alias: "X",
          description: "Longitude",
          searchPattern: numberSearchPattern
        },
        {
          alias: "Y",
          description: "Latitude",
          searchPattern: numberSearchPattern
        },
        {
          alias: "Z",
          description: "Elevation",
          searchPattern: numberSearchPattern
        }],
        defaultPattern: "X, Y, Z"
      });

      // add our new format to the widget's dropdown
      ccWidget.formats.add(newFormat);

      /**
       * Create a new Format 'SPS I', which looks like: "<X>, <Y>" in the
       * California StatePlane Zone I Spatial Reference, described by wkid 102241
       *
       * For this Format, we only need to provide a spatialReference with the correct
       * wkid. The geometry service can take care of the rest.
       */
      var stateplaneCA = new Format({
        name: "SPS I",
        conversionInfo: {
          spatialReference: new SpatialReference({
            wkid: 32610
          }),
          convert: function(point) {
            var returnPoint = point;
            var x = returnPoint.x.toFixed(0);
            var y = returnPoint.y.toFixed(0);
            bob = demImageLayer.identify(returnPoint);
            bob.then((response) => {
              Cathy = Math.round(response.value * 10) / 10;
            });
            var z = Cathy;
            return {
              location: returnPoint,
              coordinate: `${x}, ${y}, ${z}`
            };
          },
          reverseConvert: function(string, format) {
            var parts = string.split(",")
            myPoint =  new Point({
                x: parseFloat(parts[0]),
                y: parseFloat(parts[1]),
                z: -10
            });
            return new Point({
              x: parseFloat(parts[0]),
              y: parseFloat(parts[1]),
              spatialReference: {
                wkid: 32610
              }
            });
          }
        },
        coordinateSegments: [
        {
          alias: "X",
          description: "easting",
          searchPattern: numberSearchPattern
        },
        {
          alias: "Y",
          description: "northing",
          searchPattern: numberSearchPattern
        },
        {
          alias: "Z",
          description: "elevation",
          searchPattern: numberSearchPattern
        }],
        defaultPattern: "X, Y, Z"
      });

      // Add our new format to the widget's dropdown
      ccWidget.formats.add(stateplaneCA);

      // Add the two custom formats to the top of the widget's display
      ccWidget.conversions.splice(0, 0,
        new Conversion({
          format: newFormat
        }),
        new Conversion({
          format: stateplaneCA
        })
      );
    });
  </script>

</head>

<body class="calcite">
  <div id="viewDiv"></div>
</body>