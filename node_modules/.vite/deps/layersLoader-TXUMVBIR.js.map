{
  "version": 3,
  "sources": ["../../@arcgis/core/portal/support/layersLoader.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.28/esri/copyright.txt for details.\n*/\nimport e from\"../../core/Error.js\";import{parse as t}from\"../../layers/support/arcgisLayerUrl.js\";import{fetchFeatureService as r}from\"../../layers/support/fetchService.js\";import{LayerLoadContext as a}from\"../../layers/support/LayerLoadContext.js\";import{populateGroupLayer as n}from\"../../layers/support/layersCreator.js\";import{layerLookupMap as o}from\"../../layers/support/lazyLayerLoader.js\";import s from\"../Portal.js\";import{createForItemRead as l,createForGroupLayerItemRead as i}from\"./jsonContext.js\";import{preprocessFSItemData as p,getSubtypeGroupLayerIds as u,getOrientedImageryLayerIds as c,populateSceneServiceItemData as y,getNumLayersAndTables as f,createSublayerData as d,getFirstLayerOrTableId as m}from\"./loadUtils.js\";import{hasTypeKeyword as h}from\"./portalItemUtils.js\";import{loadStyleRenderer as w}from\"../../renderers/support/styleUtils.js\";import{fetchArcGISServiceJSON as b}from\"../../support/requestPresets.js\";async function g(e,t){const r=e.instance.portalItem;if(r?.id)return await r.load(t),I(e),L(e,t)}function I(t){const r=t.instance.portalItem;if(!r?.type||!t.supportedTypes.includes(r.type))throw new e(\"portal:invalid-layer-item-type\",\"Invalid layer item type '${type}', expected '${expectedType}'\",{type:r?.type,expectedType:t.supportedTypes.join(\", \")})}async function L(e,t){const r=e.instance,n=r.portalItem;if(!n)return;const{url:o,title:s}=n,i=l(n);if(\"group\"===r.type)return S(r,i,e);o&&r.read({url:o},i);const p=new a,u=await F(e,p,t);return u&&r.read(u,i),r.resourceReferences={portalItem:n,paths:i.readResourcePaths??[]},\"subtype-group\"!==r.type&&r.read({title:s},i),w(r,i)}async function S(t,r,a){const n=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:o,type:s}=n;if(\"Group Layer\"===s){if(!h(n,\"Map\"))throw new e(\"portal:invalid-layer-item-typekeyword\",\"'Group Layer' item without 'Map' type keyword is not supported\");return T(t)}return t.read({title:o},r),j(t,a)}async function T(e){const t=e.portalItem,r=await t.fetchData(\"json\");if(!r)return;const a=i(t);e.read(r,a),await n(e,r,{context:a}),e.resourceReferences={portalItem:t,paths:a.readResourcePaths??[]}}async function j(t,r){let n;const{portalItem:o}=t;if(!o)return;const s=o.type,l=r.layerModuleTypeMap;switch(s){case\"Feature Service\":case\"Feature Collection\":n=l.FeatureLayer;break;case\"Stream Service\":n=l.StreamLayer;break;case\"Scene Service\":n=l.SceneLayer;break;default:throw new e(\"portal:unsupported-item-type-as-group\",`The item type '${s}' is not supported as a 'IGroupLayer'`)}const i=new a;let[d,m]=await Promise.all([n(),F(r,i)]),h=()=>d;if(\"Feature Service\"===s){m=o.url?await p(m,o.url,i):{};const e=u(m),r=c(m),a=[];if(e.length||r?.length){e.length&&a.push(\"SubtypeGroupLayer\"),r?.length&&a.push(\"OrientedImageryLayer\");const t=[];for(const e of a){const r=l[e];t.push(r())}const n=await Promise.all(t),o=new Map;a.forEach(((e,t)=>{o.set(e,n[t])})),h=e=>e.layerType?o.get(e.layerType)??d:d}const n=await E(o.url);return await M(t,h,m,n)}return\"Scene Service\"===s&&o.url&&(m=await y(o,m,i)),f(m)>0?await M(t,h,m):await v(t,h)}async function v(e,t){const{portalItem:r}=e;if(!r?.url)return;const a=await b(r.url);a&&M(e,t,{layers:a.layers?.map(d),tables:a.tables?.map(d)})}async function M(e,t,r,a){let n=r.layers||[];const s=r.tables||[];if(\"Feature Collection\"===e.portalItem?.type?(n.forEach(((e,t)=>{e.id=t,\"Table\"===e?.layerDefinition?.type&&s.push(e)})),n=n.filter((e=>\"Table\"!==e?.layerDefinition?.type))):(n.reverse(),s.reverse()),n.forEach((n=>{const o=a?.(n);if(o||!a){const a=x(e,t(n),r,n,o);e.add(a)}})),s.length){const t=await o.FeatureLayer();s.forEach((n=>{const o=a?.(n);if(o||!a){const a=x(e,t,r,n,o);e.tables.add(a)}}))}}function x(e,t,r,a,n){const o=e.portalItem,l={portalItem:o.clone(),layerId:a.id};null!=a.url&&(l.url=a.url);const i=new t(l);if(\"sourceJSON\"in i&&(i.sourceJSON=n),\"subtype-group\"!==i.type&&(i.sublayerTitleMode=\"service-name\"),\"Feature Collection\"===o.type){const e={origin:\"portal-item\",portal:o.portal||s.getDefault()};i.read(a,e);const t=r.showLegend;null!=t&&i.read({showLegend:t},e)}return i}async function F(e,t,r){if(!1===e.supportsData)return;const a=e.instance,n=a.portalItem;if(!n)return;let o=null;try{o=await n.fetchData(\"json\",r)}catch(s){}if(D(a)){let e=null;const r=await P(n,o,t);if((o?.layers||o?.tables)&&r>0){if(null==a.layerId){const e=u(o);a.layerId=\"subtype-group\"===a.type?e?.[0]:m(o)}e=C(o,a),e&&null!=o.showLegend&&(e.showLegend=o.showLegend)}return r>1&&\"sublayerTitleMode\"in a&&\"service-name\"!==a.sublayerTitleMode&&(a.sublayerTitleMode=\"item-title-and-service-name\"),e}return o}async function P(e,r,a){if(r?.layers&&r?.tables)return f(r);const n=t(e.url);if(!n)return 1;const o=await a.fetchServiceMetadata(n.url.path).catch((()=>null));return(r?.layers?.length??o?.layers?.length??0)+(r?.tables?.length??o?.tables?.length??0)}function C(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&k(a,t)?a:null}function D(e){return\"stream\"!==e.type&&\"layerId\"in e}function k(e,t){return!(\"feature\"===t.type&&\"layerType\"in e&&\"SubtypeGroupLayer\"===e.layerType||\"subtype-group\"===t.type&&!(\"layerType\"in e))}async function E(e){const{layersJSON:t}=await r(e);if(!t)return null;const a=[...t.layers,...t.tables];return e=>a.find((t=>t.id===e.id))}export{g as load};\n"],
  "mappings": "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",
  "names": ["e", "t", "r", "n", "s", "i", "p", "a", "j", "l", "o", "_a"]
}
